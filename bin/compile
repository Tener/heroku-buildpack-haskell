#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# Fail fast and fail hard.
set -eo pipefail

BUILD_DIR=$1
CACHE_DIR=$2

FIXED_HOME=/app

mkdir -p $CACHE_DIR

if [ ! -e $CACHE_DIR/ghc ]; then
  GHC_URL="http://informatik.uni-kiel.de/~sad/ghc.tar.gz"
  echo "-----> Downloading GHC"
  curl -# --max-time 120 -L "$GHC_URL" | tar xz -C $CACHE_DIR
fi

# Restore GHC registry if available
if [ -e $CACHE_DIR/dotghc ]; then
  rm -rf $FIXED_HOME/app/.ghc
  mv $CACHE_DIR/dotghc $FIXED_HOME/.ghc
fi

# Fix directory
mv $CACHE_DIR/ghc $FIXED_HOME

# Restore Cabal cache or download an empty environemt
if [ -e $CACHE_DIR/cabal ]; then
  rm -rf $FIXED_HOME/.cabal
  mv $CACHE_DIR/cabal $FIXED_HOME/.cabal
elif [ ! -e $FIXED_HOME/.cabal ]; then
  CABAL_URL="http://informatik.uni-kiel.de/~sad/cabal.tar.gz"
  echo "-----> Downloading Cabal"
  curl -# --max-time 120 -L "$CABAL_URL" | tar xz -C $FIXED_HOME
fi

# Set LD_LIBRARAY_PATH and link essential libraries
mkdir -p $FIXED_HOME/usr/lib
ln -s /usr/lib/libgmp.so.3.5.2 $FIXED_HOME/usr/lib/libgmp.so
export LD_LIBRARY_PATH=$FIXED_HOME/usr/lib

# Set PATH
export PATH=$FIXED_HOME/ghc/bin:$FIXED_HOME/.cabal/bin$PATH

echo "-----> Updating Cabal"
cabal update

echo "-----> Installing cabal-dev"
if [ ! -e $CACHE_DIR/cabal-dev ]; then
  cabal install cabal-dev -j5
fi

echo "-----> Adding sdists"
cd $BUILD_DIR
cabal-dev add-source prepared-sdists/*

echo "-----> Download & unpack .deb packages"

getdeb() {
    PACKAGE=`echo $1 | cut -d _ -f 1`
    URI=`apt-cache show $PACKAGE | grep "Filename:" | cut -f 2 -d " "`
    echo DOWNLOAD: $PACKAGE http://archive.ubuntu.com/ubuntu/$URI
    curl -L http://archive.ubuntu.com/ubuntu/$URI --output debs/$PACKAGE.deb
    dpkg -x debs/$PACKAGE.deb debs-extra/
}

rm -rf debs debs-extra
mkdir debs debs-extra

for pkg in libatlas3gf-base_3.6.0-24ubuntu1_amd64.deb libatlas-base-dev_3.6.0-24ubuntu1_amd64.deb libatlas-headers_3.6.0-24ubuntu1_all.deb libblas3gf_1.2-2build1_amd64.deb libblas-dev_1.2-2build1_amd64.deb libgfortran3_4.4.3-4ubuntu5.1_amd64.deb libgsl0-dev_1.13+dfsg-1_amd64.deb libgsl0ldbl_1.13+dfsg-1_amd64.deb liblapack3gf_3.2.1-2_amd64.deb liblapack-dev_3.2.1-2_amd64.deb 
do
    getdeb $pkg
done

echo "-----> Try hmatrix first..."
LD_LIBRARY_PATH=$BUILD_DIR/debs-extra/usr/lib cabal-dev install hmatrix --disable-library-profiling --disable-executable-profiling --disable-shared --extra-include-dirs=$BUILD_DIR/debs-extra/usr/include --extra-lib-dirs=$BUILD_DIR/debs-extra/usr/lib

echo "-----> Release the hounds! Installing application"
cabal-dev install --disable-library-profiling --disable-executable-profiling --disable-shared --extra-include-dirs=$BUILD_DIR/debs-extra/usr/include --extra-lib-dirs=$BUILD_DIR/debs-extra/usr/lib


echo "-----> Caching Cabal packages"
echo $FIXED_HOME/.ghc
shopt -s extglob
rm $FIXED_HOME/.cabal/bin/!(cabal|happy|alex|cabal-dev)
mv $FIXED_HOME/.cabal $CACHE_DIR/cabal
mv $FIXED_HOME/ghc $CACHE_DIR/ghc
mv $FIXED_HOME/.ghc $CACHE_DIR/dotghc

echo "Cache dir size:"
du -hs $CACHE_DIR
echo "Build dir size:"
du -hs $BUILD_DIR
